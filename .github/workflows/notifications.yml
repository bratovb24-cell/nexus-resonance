name: Notifications for Critical Events

on:
  workflow_run:
    workflows:
      - "CodeQL Advanced Security Scanning"
      - "NEXUS Ï†-Metric Alerts"
    types:
      - completed

  issues:
    types: [opened, labeled]

jobs:
  notify-on-failure:
    name: Notify on Critical Events
    runs-on: ubuntu-latest

    if: |
      github.event.workflow_run.conclusion == 'failure' ||
      github.event_name == 'issues'

    permissions:
      issues: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Workflow Failure Notification
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            console.log(`Workflow: ${workflow.name}`);
            console.log(`Conclusion: ${workflow.conclusion}`);
            console.log(`Run: ${workflow.html_url}`);

      - name: Critical Issue Notification
        if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'critical')
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            console.log(`Critical issue opened: #${issue.number}`);
            console.log(`Title: ${issue.title}`);
            console.log(`URL: ${issue.html_url}`);

      - name: Log notification event to VPS
        if: always()
        run: |
          EVENT_TYPE="${{ github.event_name }}"
          WORKFLOW="${{ github.event.workflow_run.name || 'N/A' }}"

          curl -s -X POST "http://176.123.169.38:5000/vps" \
            -H "Content-Type: application/json" \
            -d "{"key":"claude2025","cmd":"python3 /opt/bridge/memory_cli.py add NOTIFICATION_SENT event_type=$EVENT_TYPE workflow=$WORKFLOW"}" \
            --connect-timeout 10 --max-time 30 || true
