name: Create Release & Generate Release Notes

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: tag_name
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "VERSION_NUM=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.tag_name.outputs.VERSION }}"
          echo "Generating release notes for $VERSION..."

          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "initial")
          if [ "$PREV_TAG" = "initial" ]; then
            COMMITS=$(git log --oneline --format="- %h: %s")
          else
            COMMITS=$(git log --oneline $PREV_TAG..HEAD --format="- %h: %s")
          fi

          NOTES="## ðŸš€ Release $VERSION

### New Features & Improvements
$COMMITS

### ðŸ“Š Project Status
- **NEXUS Resonance Ï†-Monitor**
- **Phase:** Completion Stage
- **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

### ðŸ”— Important Links
- Dashboard: https://bratovb24-cell.github.io/nexus-resonance/
- Project Board: https://github.com/users/bratovb24-cell/projects/1
- Documentation: https://github.com/bratovb24-cell/nexus-resonance/docs

---
*Generated by automated release workflow*"

          echo 'RELEASE_NOTES<<EOF' >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.tag_name.outputs.VERSION }}';
            const releaseNotes = process.env.RELEASE_NOTES;

            const response = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              body: releaseNotes,
              draft: false,
              prerelease: version.includes('alpha') || version.includes('beta')
            });

            console.log(`âœ… Release ${version} created successfully`);
            console.log(`   URL: ${response.data.html_url}`);

      - name: Log Release to VPS
        if: always()
        run: |
          VERSION="${{ steps.tag_name.outputs.VERSION }}"
          curl -s -X POST "http://176.123.169.38:5000/vps" \
            -H "Content-Type: application/json" \
            -d "{"key":"claude2025","cmd":"python3 /opt/bridge/memory_cli.py add RELEASE_CREATED âœ… GitHub Release $VERSION created with auto-generated notes"}" \
            --connect-timeout 10 --max-time 30 || true
