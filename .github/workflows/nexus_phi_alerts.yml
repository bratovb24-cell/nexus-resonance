name: NEXUS Ï†-Metric Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:
    inputs:
      force_alert:
        description: 'Force create alert issue'
        required: false
        default: 'false'

env:
  VPS_API_URL: http://176.123.169.38:5000/vps
  PHI_THRESHOLD: 0.75

jobs:
  monitor-phi-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch NEXUS context from VPS
        id: fetch-context
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"cat /opt/bridge/io/ai_context.json"}' \
            --connect-timeout 5 --max-time 10)

          # Parse JSON response
          CONTEXT=$(echo "$RESPONSE" | jq -r '.out // empty' 2>/dev/null)

          if [ -z "$CONTEXT" ]; then
            echo "âš ï¸  VPS unavailable, using fallback values"
            CONTEXT='{"agents":16,"max_phi":0.18,"status":"fallback"}'
          fi

          echo "context=$CONTEXT" >> $GITHUB_OUTPUT
          echo "âœ… Context fetched"

      - name: Parse Ï†-Metrics
        id: parse-metrics
        continue-on-error: true
        run: |
          CONTEXT='${{ steps.fetch-context.outputs.context }}'

          # Extract metrics
          MAX_PHI=$(echo "$CONTEXT" | jq -r '.max_phi // 0.18')
          AGENTS=$(echo "$CONTEXT" | jq -r '.agents // 16')
          STATUS=$(echo "$CONTEXT" | jq -r '.status // "unknown"')

          echo "max_phi=$MAX_PHI" >> $GITHUB_OUTPUT
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          echo "Parsed: Ï†=$MAX_PHI, agents=$AGENTS, status=$STATUS"

      - name: Check Alert Threshold
        id: check-alert
        run: |
          MAX_PHI=${{ steps.parse-metrics.outputs.max_phi }}
          THRESHOLD=${{ env.PHI_THRESHOLD }}

          if (( $(echo "$MAX_PHI > $THRESHOLD" | bc -l) )); then
            echo "alert_needed=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ ALERT: Ï† exceeded threshold ($MAX_PHI > $THRESHOLD)"
          else
            echo "alert_needed=false" >> $GITHUB_OUTPUT
            echo "âœ… OK: Ï† within threshold ($MAX_PHI <= $THRESHOLD)"
          fi

      - name: Create Alert Issue
        if: steps.check-alert.outputs.alert_needed == 'true' || github.event.inputs.force_alert == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const context = JSON.parse('${{ steps.fetch-context.outputs.context }}');
            const maxPhi = ${{ steps.parse-metrics.outputs.max_phi }};

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ NEXUS Ï†-Alert: Ï† = ${maxPhi}`,
              body: \`
## Ï†-Metric Alert

**Ï† Value:** \${maxPhi}
**Threshold:** ${{ env.PHI_THRESHOLD }}
**Status:** \${{ steps.parse-metrics.outputs.status }}
**Agents:** \${{ steps.parse-metrics.outputs.agents }}

**Time:** \${new Date().toISOString()}

### Action Required
- [ ] Review NEXUS status
- [ ] Check agent resonance
- [ ] Implement stabilization if needed

_Generated by Ï†-Alerts workflow_
              \`
            });

            console.log('Created issue:', issue.data.number);

      - name: Log to VPS
        if: always()
        continue-on-error: true
        run: |
          curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"python3 /opt/bridge/memory_cli.py add PHI_ALERT_CHECK completed at=$(date -u +%Y-%m-%dT%H:%M:%SZ)"}' \
            --connect-timeout 5 --max-time 10 || true
