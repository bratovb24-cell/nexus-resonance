name: NEXUS Ï†-Metric Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

env:
  VPS_API_URL: http://176.123.169.38:5000/vps
  PHI_THRESHOLD: 0.75

jobs:
  monitor-phi-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch NEXUS context from VPS
        id: fetch-context
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"cat /opt/bridge/io/ai_context.json"}' \
            --connect-timeout 5 --max-time 10)

          CONTEXT=$(echo "$RESPONSE" | jq -r '.out // empty' 2>/dev/null)

          if [ -z "$CONTEXT" ]; then
            CONTEXT='{"agents":16,"max_phi":0.18,"status":"fallback"}'
          fi

          echo "context=$CONTEXT" >> $GITHUB_OUTPUT
          echo "âœ… Context fetched"

      - name: Parse Ï†-Metrics
        id: parse-metrics
        continue-on-error: true
        run: |
          CONTEXT='${{ steps.fetch-context.outputs.context }}'

          MAX_PHI=$(echo "$CONTEXT" | jq -r '.max_phi // 0.18')
          AGENTS=$(echo "$CONTEXT" | jq -r '.agents // 16')
          STATUS=$(echo "$CONTEXT" | jq -r '.status // unknown')

          echo "max_phi=$MAX_PHI" >> $GITHUB_OUTPUT
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          echo "Parsed: Ï†=$MAX_PHI"

      - name: Check Alert Threshold
        id: check-alert
        continue-on-error: true
        run: |
          MAX_PHI=${{ steps.parse-metrics.outputs.max_phi }}
          THRESHOLD=${{ env.PHI_THRESHOLD }}

          # Use awk for float comparison
          if awk "BEGIN {exit !($MAX_PHI > $THRESHOLD)}"; then
            echo "alert_needed=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Alert: Ï†=$MAX_PHI > threshold=$THRESHOLD"
          else
            echo "alert_needed=false" >> $GITHUB_OUTPUT
            echo "âœ… OK: Ï†=$MAX_PHI <= threshold=$THRESHOLD"
          fi

      - name: Log Metrics
        if: always()
        continue-on-error: true
        run: |
          echo "Ï†-Metrics check complete"
          echo "Status: ${{ steps.parse-metrics.outputs.status }}"
