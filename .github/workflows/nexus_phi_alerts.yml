name: NEXUS œÜ-Metric Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:
    inputs:
      force_alert:
        description: 'Force create alert issue'
        required: false
        default: 'false'

env:
  VPS_API_URL: http://176.123.169.38:5000/vps
  PHI_THRESHOLD: 0.75

jobs:
  monitor-phi-metrics:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch NEXUS context from VPS
        id: fetch-context
        continue-on-error: true
        run: |
          echo "üîç Fetching NEXUS context from VPS..."

          RESPONSE=$(curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"cat /opt/bridge/io/ai_context.json"}' \
            --connect-timeout 10 \
            --max-time 30)

          echo "Response: $RESPONSE"

          # Extract output from response
          CONTEXT=$(echo "$RESPONSE" | jq -r '.out // empty')

          if [ -z "$CONTEXT" ]; then
            echo "‚ö†Ô∏è  Warning: Could not fetch context from VPS"
            echo "Using cached/default values"
            CONTEXT='{"agents":16,"max_phi":0.18,"status":"unknown"}'
          fi

          echo "context=$CONTEXT" >> $GITHUB_OUTPUT

      - name: Parse œÜ metrics
        id: parse-phi
        run: |
          CONTEXT='${{ steps.fetch-context.outputs.context }}'

          # Default values if parsing fails
          MAX_PHI=$(echo "$CONTEXT" | jq -r '.max_phi // 0.18' 2>/dev/null || echo "0.18")
          AGENTS=$(echo "$CONTEXT" | jq -r '.agents // 16' 2>/dev/null || echo "16")
          STATUS=$(echo "$CONTEXT" | jq -r '.status // "stable"' 2>/dev/null || echo "stable")

          echo "max_phi=$MAX_PHI" >> $GITHUB_OUTPUT
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          echo "üìä Parsed Metrics:"
          echo "   Max œÜ: $MAX_PHI"
          echo "   Agents: $AGENTS"
          echo "   Status: $STATUS"

      - name: Check if alert needed
        id: check-alert
        run: |
          MAX_PHI=${{ steps.parse-phi.outputs.max_phi }}
          THRESHOLD=${{ env.PHI_THRESHOLD }}

          # Convert to comparable format
          ALERT_NEEDED=$(awk -v max="$MAX_PHI" -v threshold="$THRESHOLD" 'BEGIN{print (max > threshold ? "true" : "false")}')

          echo "alert_needed=$ALERT_NEEDED" >> $GITHUB_OUTPUT
          echo "Alert needed: $ALERT_NEEDED (max_phi=$MAX_PHI > threshold=$THRESHOLD)"

      - name: Create alert issue (if needed)
        if: steps.check-alert.outputs.alert_needed == 'true' || github.event.inputs.force_alert == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const maxPhi = '${{ steps.parse-phi.outputs.max_phi }}';
            const agents = '${{ steps.parse-phi.outputs.agents }}';
            const status = '${{ steps.parse-phi.outputs.status }}';

            const title = `‚ö†Ô∏è HIGH œÜ-METRIC ALERT: ${maxPhi}`;
            const body = `## œÜ-Metric Status Alert

**Max œÜ-Metric:** ${maxPhi} (threshold: ${{ env.PHI_THRESHOLD }})
**Active Agents:** ${agents}
**System Status:** ${status}

**Action:** Review NEXUS resonance stability and agent loads.

_Auto-generated by NEXUS monitoring system_`;

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['alert', 'phi-metric', 'critical']
              });
              console.log(`‚úÖ Alert issue created: #${issue.data.number}`);
            } catch (error) {
              console.error('Error creating issue:', error);
            }

      - name: Log to VPS
        if: always()
        continue-on-error: true
        run: |
          curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"python3 /opt/bridge/memory_cli.py add PHI_MONITOR_RUN max_phi=${{ steps.parse-phi.outputs.max_phi }} status=success"}' \
            --connect-timeout 10 --max-time 30 || true
