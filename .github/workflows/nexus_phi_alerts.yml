name: NEXUS Ï†-Metric Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

env:
  VPS_API_URL: http://176.123.169.38:5000/vps
  PHI_THRESHOLD: 0.75
  CACHE_DIR: ~/.nexus-cache

jobs:
  monitor-phi-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache VPS Context
        uses: actions/cache@v3
        id: cache-vps
        with:
          path: ~/.nexus-cache
          key: ${{ runner.os }}-vps-context-${{ hashFiles('.github/workflows/nexus_phi_alerts.yml') }}
          restore-keys: |
            ${{ runner.os }}-vps-context-

      - name: Setup Cache Directory
        run: |
          mkdir -p ${{ env.CACHE_DIR }}
          echo "âœ… Cache directory ready"

      - name: Fetch NEXUS context from VPS
        id: fetch-context
        continue-on-error: true
        run: |
          CACHE_FILE="${{ env.CACHE_DIR }}/last_context.json"

          # Try to fetch fresh context
          RESPONSE=$(curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"cat /opt/bridge/io/ai_context.json"}' \
            --connect-timeout 5 --max-time 10 2>/dev/null)

          CONTEXT=$(echo "$RESPONSE" | jq -r '.out // empty' 2>/dev/null)

          # If fetch failed, try cached context
          if [ -z "$CONTEXT" ] && [ -f "$CACHE_FILE" ]; then
            echo "âš ï¸ Using cached context"
            CONTEXT=$(cat "$CACHE_FILE")
          fi

          # If still empty, use fallback
          if [ -z "$CONTEXT" ]; then
            CONTEXT='{"agents":16,"max_phi":0.18,"status":"fallback"}'
            echo "âš ï¸ Using fallback context"
          else
            # Save to cache for next time
            echo "$CONTEXT" > "$CACHE_FILE"
            echo "âœ… Context cached"
          fi

          echo "context=$CONTEXT" >> $GITHUB_OUTPUT
          echo "âœ… Context ready"

      - name: Parse Ï†-Metrics
        id: parse-metrics
        continue-on-error: true
        run: |
          CONTEXT='${{ steps.fetch-context.outputs.context }}'

          MAX_PHI=$(echo "$CONTEXT" | jq -r '.max_phi // 0.18')
          AGENTS=$(echo "$CONTEXT" | jq -r '.agents // 16')
          STATUS=$(echo "$CONTEXT" | jq -r '.status // "unknown"')

          echo "max_phi=$MAX_PHI" >> $GITHUB_OUTPUT
          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          echo "âœ… Parsed: Ï†=$MAX_PHI, agents=$AGENTS, status=$STATUS"

      - name: Check Alert Threshold
        id: check-alert
        continue-on-error: true
        run: |
          MAX_PHI=${{ steps.parse-metrics.outputs.max_phi }}
          THRESHOLD=${{ env.PHI_THRESHOLD }}

          # Use awk for float comparison
          if awk "BEGIN {exit !($MAX_PHI > $THRESHOLD)}"; then
            echo "alert_needed=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Alert: Ï†=$MAX_PHI > threshold=$THRESHOLD"
          else
            echo "alert_needed=false" >> $GITHUB_OUTPUT
            echo "âœ… OK: Ï†=$MAX_PHI <= threshold=$THRESHOLD"
          fi

      - name: Create Alert Issue (if needed)
        if: steps.check-alert.outputs.alert_needed == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const phi = '${{ steps.parse-metrics.outputs.max_phi }}';
            const agents = '${{ steps.parse-metrics.outputs.agents }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Ï†-Alert: Critical Ï†=${phi} exceeded threshold`,
              body: `## Ï†-Metric Alert\n\n- **Ï† Value:** ${phi}\n- **Threshold:** ${{ env.PHI_THRESHOLD }}\n- **Agents:** ${agents}\n- **Time:** ${new Date().toISOString()}\n\n### Action Required\nInvestigate and stabilize the system.`,
              labels: ['Ï†-metric', 'high-priority']
            });

      - name: Log Metrics
        if: always()
        continue-on-error: true
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ï†-Metrics Check Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ï† Value: ${{ steps.parse-metrics.outputs.max_phi }}"
          echo "Agents: ${{ steps.parse-metrics.outputs.agents }}"
          echo "Status: ${{ steps.parse-metrics.outputs.status }}"
          echo "Alert: ${{ steps.check-alert.outputs.alert_needed }}"
          echo "Cache Hit: ${{ steps.cache-vps.outputs.cache-hit }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
