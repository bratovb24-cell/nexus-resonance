name: NEXUS œÜ-Metric Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:
    inputs:
      force_alert:
        description: 'Force create alert issue'
        required: false
        default: 'false'

env:
  VPS_API_URL: http://176.123.169.38:5000/vps
  PHI_THRESHOLD: 0.75

jobs:
  monitor-phi-metrics:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === CACHING STEP (NEW!) ===
      - name: Cache context data
        uses: actions/cache@v3
        id: context-cache
        with:
          path: ~/.nexus-cache
          key: nexus-context-${{ github.run_id }}
          restore-keys: |
            nexus-context-

      - name: Setup cache directory
        run: mkdir -p ~/.nexus-cache

      - name: Fetch NEXUS context from VPS
        id: fetch-context
        run: |
          echo "üîç Fetching NEXUS context from VPS..."

          RESPONSE=$(curl -s -X POST "${{ env.VPS_API_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"cat /opt/bridge/io/ai_context.json"}' \
            --connect-timeout 30 \
            --max-time 60)

          # Extract output from response
          CONTEXT=$(echo "$RESPONSE" | jq -r '.out // empty')

          if [ -z "$CONTEXT" ]; then
            echo "‚ùå Failed to fetch context"
            echo "Response: $RESPONSE"
            exit 1
          fi

          # Save to cache
          echo "$CONTEXT" > ~/.nexus-cache/last_context.json

          # Parse agents and find max phi
          AGENTS=$(echo "$CONTEXT" | jq -r '.agents // {}' 2>/dev/null || echo '{}')

          # Calculate max phi
          MAX_PHI=$(echo "$AGENTS" | jq -r 'to_entries | map(.value | tonumber) | max // 0' 2>/dev/null || echo "0")
          MAX_AGENT=$(echo "$AGENTS" | jq -r 'to_entries | max_by(.value | tonumber) | .key // "unknown"' 2>/dev/null || echo "unknown")
          AGENT_COUNT=$(echo "$AGENTS" | jq -r 'length' 2>/dev/null || echo "0")
          AVG_PHI=$(echo "$AGENTS" | jq -r 'to_entries | map(.value | tonumber) | add / length // 0' 2>/dev/null || echo "0")

          echo "üìä NEXUS Status:"
          echo "   Max œÜ: $MAX_PHI ($MAX_AGENT)"
          echo "   Avg œÜ: $AVG_PHI"
          echo "   Agents: $AGENT_COUNT"

          # Set outputs
          echo "max_phi=$MAX_PHI" >> $GITHUB_OUTPUT
          echo "max_agent=$MAX_AGENT" >> $GITHUB_OUTPUT
          echo "agent_count=$AGENT_COUNT" >> $GITHUB_OUTPUT
          echo "avg_phi=$AVG_PHI" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

          # Compare with cached previous value
          if [ -f ~/.nexus-cache/prev_max_phi.txt ]; then
            PREV_PHI=$(cat ~/.nexus-cache/prev_max_phi.txt)
            DELTA=$(awk "BEGIN {print $MAX_PHI - $PREV_PHI}")
            echo "   Delta: $DELTA (vs previous)"
            echo "phi_delta=$DELTA" >> $GITHUB_OUTPUT
          fi

          # Save current as previous for next run
          echo "$MAX_PHI" > ~/.nexus-cache/prev_max_phi.txt

      - name: Check threshold and create alert
        if: |
          ${{ fromJson(steps.fetch-context.outputs.max_phi) > fromJson(env.PHI_THRESHOLD) || 
              github.event.inputs.force_alert == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const maxPhi = '${{ steps.fetch-context.outputs.max_phi }}';
            const maxAgent = '${{ steps.fetch-context.outputs.max_agent }}';
            const agentCount = '${{ steps.fetch-context.outputs.agent_count }}';
            const avgPhi = '${{ steps.fetch-context.outputs.avg_phi }}';
            const timestamp = '${{ steps.fetch-context.outputs.timestamp }}';
            const forceAlert = '${{ github.event.inputs.force_alert }}' === 'true';

            const title = forceAlert 
              ? `üîî MANUAL ALERT: œÜ = ${maxPhi} (${maxAgent})`
              : `‚ö†Ô∏è HIGH PHI ALERT: œÜ = ${maxPhi} (${maxAgent})`;

            const body = `## üö® NEXUS Resonance Alert

**Timestamp:** ${timestamp}
**Triggered by:** ${forceAlert ? 'Manual dispatch' : 'Automated monitoring'}

### œÜ-Metric Status

| Metric | Value |
|--------|-------|
| Max œÜ | **${maxPhi}** |
| Agent | ${maxAgent} |
| Threshold | 0.75 |
| Average œÜ | ${avgPhi} |
| Active Agents | ${agentCount} |

### Action Required

${forceAlert ? '‚ö° This is a manual test alert.' : '‚ö†Ô∏è œÜ-metric exceeded threshold! Investigate immediately.'}

---
*Generated by NEXUS œÜ-Metric Alerts workflow*
*Dashboard: https://bratovb24-cell.github.io/nexus-resonance/*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['alert', 'phi-metric', forceAlert ? 'test' : 'critical']
            });

            console.log('‚úÖ Alert issue created successfully');

      - name: Log status (always runs)
        if: always()
        run: |
          echo "=================================="
          echo "üìä NEXUS Monitor Summary"
          echo "=================================="
          echo "Max œÜ: ${{ steps.fetch-context.outputs.max_phi }}"
          echo "Agent: ${{ steps.fetch-context.outputs.max_agent }}"
          echo "Count: ${{ steps.fetch-context.outputs.agent_count }}"
          echo "Time:  ${{ steps.fetch-context.outputs.timestamp }}"
          echo "=================================="

          MAX_PHI="${{ steps.fetch-context.outputs.max_phi }}"
          THRESHOLD="${{ env.PHI_THRESHOLD }}"

          if (( $(echo "$MAX_PHI > $THRESHOLD" | bc -l 2>/dev/null || echo 0) )); then
            echo "‚ö†Ô∏è  STATUS: ALERT TRIGGERED"
          else
            echo "‚úÖ STATUS: STABLE"
          fi
