name: NEXUS Ï†-Metric Alerts

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  analyze-phi-metric:
    runs-on: ubuntu-latest
    name: Analyze Ï†-Metrics and Create Alerts

    steps:
      - name: Fetch NEXUS context from VPS
        id: fetch-context
        run: |
          response=$(curl -s -X POST http://176.123.169.38:5000/vps \
            -H "Content-Type: application/json" \
            -d '{"key":"claude2025","cmd":"cat /opt/bridge/io/ai_context.json"}' \
            --connect-timeout 10 --max-time 15)

          echo "Response received"

          if echo "$response" | jq -e '.out' > /dev/null 2>&1; then
            context=$(echo "$response" | jq -r '.out')

            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ phi Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¸ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼
            max_phi=$(echo "$context" | jq -r '.agents | to_entries | map(.value | tonumber) | max')
            agent_count=$(echo "$context" | jq -r '.agents | length')

            echo "max_phi=$max_phi" >> $GITHUB_OUTPUT
            echo "agent_count=$agent_count" >> $GITHUB_OUTPUT
            echo "âœ… Max Ï†: $max_phi, Agents: $agent_count"
          else
            echo "ERROR: Failed to parse VPS response"
            echo "max_phi=0" >> $GITHUB_OUTPUT
            echo "agent_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create HIGH_PHI_ALERT issue
        if: ${{ steps.fetch-context.outputs.max_phi > 0.75 }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const maxPhi = '${{ steps.fetch-context.outputs.max_phi }}';
            const agentCount = '${{ steps.fetch-context.outputs.agent_count }}';
            const timestamp = new Date().toISOString();

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ HIGH PHI ALERT: Ï† = ${maxPhi}`,
              body: [
                'ðŸš¨ **NEXUS Resonance Alert**',
                '',
                `**Maximum Ï†-Metric:** ${maxPhi}`,
                `**Active Agents:** ${agentCount}`,
                `**Timestamp:** ${timestamp}`,
                `**Workflow Run:** [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
                '',
                '**Threshold:** 0.75',
                '**Status:** ðŸ”´ CRITICAL',
                '',
                '> Ï†-metric exceeded critical level! System check required.'
              ].join('\n'),
              labels: ['alert', 'phi-metric', 'critical']
            });

            console.log(`âœ… Issue created for Ï† = ${maxPhi}`);

      - name: Log status
        run: |
          echo "Ï†-Metric Analysis Complete"
          echo "Max Ï†: ${{ steps.fetch-context.outputs.max_phi }}"
          echo "Agents: ${{ steps.fetch-context.outputs.agent_count }}"
