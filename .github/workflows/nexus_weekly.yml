name: NEXUS Weekly Analysis

on:
  schedule:
    - cron: '0 3 * * 0'  # Ð’Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ 03:00 UTC
  workflow_dispatch:
    inputs:
      depth:
        description: 'Analysis depth'
        type: choice
        options: ['shallow', 'deep', 'full']
        default: 'deep'

permissions:
  contents: read
  actions: read

env:
  VPS_API: http://176.123.169.38:5000/vps

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Collect System Data
        id: collect
        env:
          API_KEY: ${{ secrets.VPS_API_KEY }}
        run: |
          set -e
          mkdir -p data

          echo "Collecting system state..."

          curl -s -X POST "${{ env.VPS_API }}" \
            -d "{\"key\":\"$API_KEY\",\"cmd\":\"cat /opt/bridge/io/ai_context.json\"}" \
            -H "Content-Type: application/json" \
            | jq -r '.out' > data/context.json 2>/dev/null || echo "{}" > data/context.json

          curl -s -X POST "${{ env.VPS_API }}" \
            -d "{\"key\":\"$API_KEY\",\"cmd\":\"ps aux | grep python | wc -l\"}" \
            -H "Content-Type: application/json" \
            | jq -r '.out' > data/procs.txt 2>/dev/null || echo "0" > data/procs.txt

      - name: Generate Report
        run: |
          set -e

          python3 << 'EOF'
          import json
          from datetime import datetime

          report = []
          report.append("=" * 60)
          report.append("ðŸ”® NEXUS WEEKLY ANALYSIS")
          report.append(f"Date: {datetime.utcnow().isoformat()}")
          report.append("=" * 60)

          try:
              with open('data/context.json') as f:
                  ctx = json.load(f)

              agents = ctx.get('agents', {})
              if agents:
                  phi_vals = [float(v) if isinstance(v, str) else v for v in agents.values()]
                  report.append(f"\nAgents: {len(agents)}")
                  report.append(f"Avg Ï†: {sum(phi_vals)/len(phi_vals):.4f}")
              else:
                  report.append("\nNo agent data available")
          except Exception as e:
              report.append(f"\nContext analysis error: {e}")

          with open('weekly_report.md', 'w') as f:
              f.write('\n'.join(report))

          print('\n'.join(report))
          EOF

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_number }}
          path: weekly_report.md
          retention-days: 90

      - name: Notify VPS
        if: always()
        env:
          API_KEY: ${{ secrets.VPS_API_KEY }}
        run: |
          set +e
          curl -s -X POST "${{ env.VPS_API }}" \
            -d "{\"key\":\"$API_KEY\",\"cmd\":\"python3 /opt/bridge/memory_cli.py add weekly_report \\\"completed\\\"\"}" \
            -H "Content-Type: application/json" \
            --connect-timeout 10 || true
